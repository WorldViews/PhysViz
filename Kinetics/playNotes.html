<html xmlns = "http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<!-- polyfill -->
	<script src="wmb/Base64.js" type="text/javascript"></script>
	<script src="wmb/Base64binary.js" type="text/javascript"></script>
	<script src="wmb/WebAudioAPI.js" type="text/javascript"></script>
	<!-- midi.js package -->
	<script src="wmb/audioDetect.js" type="text/javascript"></script>
	<script src="wmb/gm.js" type="text/javascript"></script>
	<script src="wmb/loader.js" type="text/javascript"></script>
	<script src="wmb/plugin.audiotag.js" type="text/javascript"></script>
	<script src="wmb/plugin.webaudio.js" type="text/javascript"></script>
	<script src="wmb/plugin.webmidi.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="wmb/dom_request_xhr.js" type="text/javascript"></script>
	<script src="wmb/dom_request_script.js" type="text/javascript"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

</head>
<body>
<p>Play Notes with MIDI.</p>

<button onclick='loadInstrument("choir_aahs");'>Choir</button>
<button onclick='loadInstrument("acoustic_guitar_steel");'>Guitar</button>
<button onclick='loadInstrument("acoustic_grand_piano");'>Piano</button>
<button onclick='loadInstrument("violin");'>Violin</button>
<button onclick='loadInstrument("harpsichord");'>Harpsichord</button>
<p>
<button onclick='playScale()'>Play Scale</button><p>
<button onclick='playMelody("chopin69")'>Play Chopin69</button>
<button onclick='playMelody("wtc0")'>Play WTC0</button>
<button onclick='playMelody("beethovenSym5m1")'>Play BeethSym5m1</button>
<button onclick='playMelody("shepard")'>Play Shepard</button><p>
<button onclick='stopPlaying()'>Stop</button>
(this calls MIDI.stopAllNotes() but that seems to not work.)<br>
<script>

function report(str)
{
    console.log(str);
}

//var instrument = "acoustic_guitar_steel";
//var instrument = "acoustic_grand_piano";
var instrument = "choir_aahs";
//var melodyUrl = "midi/chopin69.json";
//var melodyUrl = "midi/wtc0.json";
//var melodyUrl = "midi/beethovenSym5m1.json";
//var melodyUrl = "midi/funky.json";
var melodyUrl = "midi/shepard.json";
var ticksPerBeat = 1000;

function stopPlaying()
{
   report("Stop Playing");
   MIDI.stopAllNotes();
}

function playMelody(name)
{
    var melodyUrl = "midi/"+name+".json";
    stopPlaying();
    $.getJSON(melodyUrl, function(obj) { playObj(obj) });
}

function fmt(t) { return ""+Math.floor(t*1000)/1000; }

function playObj(obj)
{
    report("Playing object");
    var notes = obj.notes;
    maxNumNotes = 0;
    var delay0 = 0;
    for (var i=0; i<notes.length; i++) {
       var note = notes[i];
       var pitch = note[0];
//       if (maxNumNotes && i > maxNumNotes)
//           break;
       for (var j=1; j<note.length; j++) {
           var tick = note[j][0];
           var v = note[j][1];
           var t = tick/ticksPerBeat;
	   //report("tick: "+tick+"  v: "+v+"  t: "+t);
           if (v) {
	       report("NoteOn "+pitch+" v: "+v+"  t: "+fmt(t));
               MIDI.noteOn(0, pitch, v, t+delay0);
           }
	   else {
	       report("NoteOff "+pitch+"  t: "+fmt(t));
               MIDI.noteOff(0, pitch, t+delay0);
           }
       }
   }
}

function playScale(){
    report("scheduling notes");
    MIDI.programChange(0, instrument);
    var firstNote = 21;
    var lastNote = firstNote + 5*12+1;
    var t = 0;
    var delay = 0.6; // delta time - time between events
    var velocity = 127; // how hard the note hits
    var note = 21; // the note to use
    MIDI.setVolume(0, 127);
    for(var note=firstNote; note <= lastNote; ++note){
        MIDI.noteOn(0, note, velocity, t);
	MIDI.noteOff(0, note, t += delay);
    }
    report("finished scheduling notes");
}


function loadInstrument(instr, successFn)
{
    instrument = instr;
    MIDI.loadPlugin({
        soundfontUrl: "./soundfont/",
	instrument: instrument,
        onprogress:function(state,progress){
           MIDI.loader.setValue(progress*100);
        },
        onprogress: function(state,progress)
		{
		     if (MIDI.loader)
                         MIDI.loader.setValue(progress*100);
		},
	onsuccess: function()
		{
		    MIDI.programChange(0, instr);
		    if (successFn)
			successFn();
		}
    });
}

window.onload = function(){
    loadInstrument(instrument);
};
</script>
</body>
</html>
